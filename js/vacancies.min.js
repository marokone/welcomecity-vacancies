// vacancies.min.js - –†–ê–ë–û–ß–ò–ô –ö–û–î
console.log('‚úÖ –ü–æ–∏—Å–∫ –≤–∞–∫–∞–Ω—Å–∏–π –∑–∞–ø—É—â–µ–Ω');

class VacancySearchApp {
    constructor() {
        this.state = {
            allVacancies: [],
            selectedProjects: [],
            selectedDepartments: [],
            searchQuery: '',
            placeholderInterval: null
        };
        this.init();
    }

    async init() {
        console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...');
        await this.loadVacancies();
        this.setupUI();
        this.renderAll();
    }

    async loadVacancies() {
        console.log('üì° –ó–∞–≥—Ä—É–∑–∫–∞...');
        
        const url = 'https://vhbiezamhpyejdqvvwuj.supabase.co/rest/v1/vacancies?select=id,title,project,department&status=eq.active&order=created_at.desc';
        const key = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZoYmllemFtaHB5ZWpkcXZ2d3VqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE2Njc0MDgsImV4cCI6MjA3NzI0MzQwOH0.13h_XJ7kQFtuCjavkOXN9TzXNF2X4jX5-rcNCFiFqO0';
        
        try {
            const response = await fetch(url, {
                headers: {
                    'apikey': key,
                    'Authorization': `Bearer ${key}`
                }
            });
            
            if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ HTTP');
            
            this.state.allVacancies = await response.json();
            console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${this.state.allVacancies.length} –≤–∞–∫–∞–Ω—Å–∏–π`);
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞:', error);
        }
    }

    setupUI() {
        // –ü–æ–∏—Å–∫
        const searchInput = document.getElementById('vacancy-search');
        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                this.state.searchQuery = e.target.value.toLowerCase();
                this.renderResults();
            });
        }
        
        // –°–±—Ä–æ—Å
        const resetBtn = document.getElementById('reset-all-filters');
        if (resetBtn) {
            resetBtn.addEventListener('click', () => this.resetFilters());
        }
    }

    renderAll() {
        this.renderResults();
        this.updateResetButton();
    }

    renderResults() {
        const results = document.getElementById('vacancy-results');
        if (!results || !this.state.allVacancies.length) return;
        
        const filtered = this.state.allVacancies.filter(v => 
            !this.state.searchQuery || 
            v.title.toLowerCase().includes(this.state.searchQuery)
        );
        
        if (!filtered.length) {
            results.innerHTML = '<p style="text-align:center; padding: 40px; color: #666;">–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</p>';
            return;
        }
        
        results.innerHTML = filtered.map(v => `
            <div class="vacancy-card-wrapper">
                <a href="/vacancy?id=${v.id}" class="vacancy-card">
                    <div class="vacancy-content">
                        <h3>${v.title}</h3>
                        <p class="vacancy-meta">${v.project} ‚Äî ${v.department}</p>
                    </div>
                    <span class="arrow-icon">‚Üí</span>
                </a>
            </div>
        `).join('');
    }

    updateResetButton() {
        const resetBtn = document.getElementById('reset-all-filters');
        if (resetBtn) {
            resetBtn.style.display = this.state.searchQuery ? 'block' : 'none';
        }
    }

    resetFilters() {
        this.state.searchQuery = '';
        const searchInput = document.getElementById('vacancy-search');
        if (searchInput) searchInput.value = '';
        this.renderAll();
    }
}

// –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫
document.addEventListener('DOMContentLoaded', () => {
    if (document.getElementById('vacancy-container')) {
        window.vacancyListApp = new VacancySearchApp();
    }
});
