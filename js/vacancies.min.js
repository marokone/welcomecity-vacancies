// vacancies.min.js
// Ultra-minimal vacancy search & filter system
// –î–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã https://welcomecity.ru/search-vacancy

class VacancySearchApp {
    constructor() {
        this.state = {
            allVacancies: [],
            selectedProjects: [],
            selectedDepartments: [],
            searchQuery: '',
            placeholderInterval: null
        };
        
        this.init();
    }

    async init() {
        console.log('üîç –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∏—Å–∫–∞ –≤–∞–∫–∞–Ω—Å–∏–π');
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        await this.loadData();
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        this.setupUI();
        
        // –ü–µ—Ä–≤—ã–π —Ä–µ–Ω–¥–µ—Ä
        this.renderAll();
        
        console.log('‚úÖ –ü–æ–∏—Å–∫ –≤–∞–∫–∞–Ω—Å–∏–π –≥–æ—Ç–æ–≤');
    }

    async loadData() {
        try {
            console.log('üì° –ó–∞–≥—Ä—É–∑–∫–∞ –≤–∞–∫–∞–Ω—Å–∏–π...');
            
            const response = await fetch(
                'https://vhbiezamhpyejdqvvwuj.supabase.co/rest/v1/vacancies?select=*&status=eq.active&order=created_at.desc',
                {
                    headers: {
                        'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZoYmllemFtaHB5ZWpkcXZ2d3VqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE2Njc0MDgsImV4cCI6MjA3NzI0MzQwOH0.13h_XJ7kQFtuCjavkOXN9TzXNF2X4jX5-rcNCFiFqO0',
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZoYmllemFtaHB5ZWpkcXZ2d3VqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE2Njc0MDgsImV4cCI6MjA3NzI0MzQwOH0.13h_XJ7kQFtuCjavkOXN9TzXNF2X4jX5-rcNCFiFqO0',
                        'Content-Type': 'application/json'
                    }
                }
            );
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data && data.length > 0) {
                this.state.allVacancies = data.map(v => ({
                    id: v.id,
                    title: v.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è',
                    project: v.project || v.project_name || '–ë–µ–∑ –ø—Ä–æ–µ–∫—Ç–∞',
                    department: v.department || '–ë–µ–∑ –æ—Ç–¥–µ–ª–∞',
                    description: v.description || ''
                }));
                
                console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${this.state.allVacancies.length} –≤–∞–∫–∞–Ω—Å–∏–π`);
            } else {
                console.log('‚ÑπÔ∏è –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –≤–∞–∫–∞–Ω—Å–∏–π');
                this.showEmptyState('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –≤–∞–∫–∞–Ω—Å–∏–π');
            }
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
            this.showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤–∞–∫–∞–Ω—Å–∏–∏');
        }
    }

    setupUI() {
        // –ü–æ–∏—Å–∫
        const searchInput = document.getElementById('vacancy-search');
        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                this.state.searchQuery = e.target.value.toLowerCase().trim();
                this.renderResults();
                this.updateResetButton();
            });
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º placeholder –∞–Ω–∏–º–∞—Ü–∏—é
            this.startPlaceholderAnimation(searchInput);
        }
        
        // –î–µ—Å–∫—Ç–æ–ø–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
        this.setupDesktopFilters();
        
        // –ú–æ–±–∏–ª—å–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
        this.setupMobileFilters();
        
        // –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞
        const resetBtn = document.getElementById('reset-all-filters');
        if (resetBtn) {
            resetBtn.addEventListener('click', () => this.resetFilters());
        }
    }

    startPlaceholderAnimation(input) {
        if (this.state.allVacancies.length === 0) return;
        
        const titles = this.state.allVacancies
            .map(v => v.title)
            .filter(t => t && t.trim())
            .slice(0, 10);
        
        if (titles.length === 0) return;
        
        let i = 0;
        const update = () => {
            input.placeholder = titles[i] || '–ù–∞–∑–≤–∞–Ω–∏–µ –≤–∞–∫–∞–Ω—Å–∏–∏';
            i = (i + 1) % titles.length;
        };
        
        update();
        
        if (this.state.placeholderInterval) {
            clearInterval(this.state.placeholderInterval);
        }
        
        this.state.placeholderInterval = setInterval(update, 1500);
    }

    setupDesktopFilters() {
        // –ü—Ä–æ–µ–∫—Ç—ã
        const projectFilter = document.getElementById('project-filter');
        if (projectFilter) {
            const header = projectFilter.querySelector('.select-header');
            const clearBtn = projectFilter.querySelector('.clear-btn');
            
            if (header) header.addEventListener('click', () => this.toggleDropdown('project'));
            if (clearBtn) clearBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                this.state.selectedProjects = [];
                this.renderAll();
            });
        }
        
        // –û—Ç–¥–µ–ª—ã
        const deptFilter = document.getElementById('department-filter');
        if (deptFilter) {
            const header = deptFilter.querySelector('.select-header');
            const clearBtn = deptFilter.querySelector('.clear-btn');
            
            if (header) header.addEventListener('click', () => this.toggleDropdown('dept'));
            if (clearBtn) clearBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                this.state.selectedDepartments = [];
                this.renderAll();
            });
        }
        
        // –ö–ª–∏–∫ –≤–Ω–µ dropdown
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.custom-select')) {
                document.querySelectorAll('.custom-select').forEach(el => 
                    el.classList.remove('active')
                );
            }
        });
    }

    setupMobileFilters() {
        const mobileBtn = document.getElementById('mobile-filters-btn');
        const mobileModal = document.getElementById('mobile-filters-modal');
        
        if (mobileBtn && mobileModal) {
            mobileBtn.addEventListener('click', () => this.openMobileFilters());
            
            mobileModal.addEventListener('click', (e) => {
                if (e.target === mobileModal) this.closeMobileFilters();
            });
        }
        
        // –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
        const applyBtn = document.getElementById('apply-mobile-filters');
        if (applyBtn) {
            applyBtn.addEventListener('click', () => {
                this.renderAll();
                this.closeMobileFilters();
            });
        }
        
        // –û—á–∏—Å—Ç–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
        const clearBtn = document.getElementById('clear-mobile-filters');
        if (clearBtn) {
            clearBtn.addEventListener('click', () => {
                this.state.selectedProjects = [];
                this.state.selectedDepartments = [];
                this.renderAll();
            });
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö dropdown
        document.querySelectorAll('.filter-item').forEach(item => {
            item.addEventListener('click', () => {
                const type = item.dataset.type;
                const dropdownId = type === 'projects' ? 'mobile-project-dropdown' : 'mobile-dept-dropdown';
                const dropdown = document.getElementById(dropdownId);
                if (dropdown) dropdown.classList.add('active');
            });
        });
        
        document.querySelectorAll('.close-dropdown').forEach(btn => {
            btn.addEventListener('click', () => {
                btn.closest('.mobile-filter-dropdown').classList.remove('active');
            });
        });
    }

    toggleDropdown(type) {
        const filterId = type === 'project' ? 'project-filter' : 'department-filter';
        const filter = document.getElementById(filterId);
        const otherId = type === 'project' ? 'department-filter' : 'project-filter';
        const otherFilter = document.getElementById(otherId);
        
        if (filter) {
            const isActive = filter.classList.contains('active');
            
            if (otherFilter) otherFilter.classList.remove('active');
            
            filter.classList.toggle('active', !isActive);
            
            if (!isActive) {
                this.renderDropdownOptions(type);
            }
        }
    }

    renderDropdownOptions(type) {
        const isProject = type === 'project';
        const filterId = isProject ? 'project-filter' : 'department-filter';
        const selected = isProject ? this.state.selectedProjects : this.state.selectedDepartments;
        
        const filter = document.getElementById(filterId);
        if (!filter) return;
        
        const dropdown = filter.querySelector('.select-dropdown');
        if (!dropdown) return;
        
        // –ü–æ–ª—É—á–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
        const values = {};
        this.state.allVacancies.forEach(v => {
            const key = isProject ? (v.project || '–ë–µ–∑ –ø—Ä–æ–µ–∫—Ç–∞') : v.department;
            if (key) values[key] = (values[key] || 0) + 1;
        });
        
        // –†–µ–Ω–¥–µ—Ä–∏–º –æ–ø—Ü–∏–∏
        dropdown.innerHTML = Object.entries(values)
            .sort(([a], [b]) => a.localeCompare(b))
            .map(([value, count]) => {
                const checked = selected.includes(value) ? 'checked' : '';
                const id = `${type}-${value.replace(/\s+/g, '-')}`;
                return `
                    <label class="select-option">
                        <input type="checkbox" value="${value}" ${checked} id="${id}">
                        <span>${value} <small>(${count})</small></span>
                    </label>
                `;
            }).join('');
        
        // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        dropdown.querySelectorAll('input').forEach(input => {
            input.addEventListener('change', (e) => {
                const value = e.target.value;
                const isChecked = e.target.checked;
                
                if (isProject) {
                    if (isChecked) {
                        if (!this.state.selectedProjects.includes(value)) {
                            this.state.selectedProjects.push(value);
                        }
                    } else {
                        this.state.selectedProjects = this.state.selectedProjects.filter(v => v !== value);
                    }
                } else {
                    if (isChecked) {
                        if (!this.state.selectedDepartments.includes(value)) {
                            this.state.selectedDepartments.push(value);
                        }
                    } else {
                        this.state.selectedDepartments = this.state.selectedDepartments.filter(v => v !== value);
                    }
                }
                
                this.renderAll();
            });
        });
    }

    renderAll() {
        this.renderFilterLabels();
        this.renderResults();
        this.updateResetButton();
        this.updateMobileFilters();
    }

    renderFilterLabels() {
        // –ü—Ä–æ–µ–∫—Ç—ã
        const projectLabel = document.querySelector('#project-filter .selected-values');
        if (projectLabel) {
            projectLabel.textContent = this.state.selectedProjects.length 
                ? this.state.selectedProjects.join(', ')
                : '–í—Å–µ –ø—Ä–æ–µ–∫—Ç—ã';
            
            const filter = document.getElementById('project-filter');
            if (filter) {
                filter.classList.toggle('has-selection', this.state.selectedProjects.length > 0);
            }
        }
        
        // –û—Ç–¥–µ–ª—ã
        const deptLabel = document.querySelector('#department-filter .selected-values');
        if (deptLabel) {
            deptLabel.textContent = this.state.selectedDepartments.length 
                ? this.state.selectedDepartments.join(', ')
                : '–í—Å–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è';
            
            const filter = document.getElementById('department-filter');
            if (filter) {
                filter.classList.toggle('has-selection', this.state.selectedDepartments.length > 0);
            }
        }
    }

    renderResults() {
        const results = document.getElementById('vacancy-results');
        if (!results) return;
        
        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è
        const filtered = this.state.allVacancies.filter(vac => {
            const matchProject = this.state.selectedProjects.length === 0 || 
                this.state.selectedProjects.includes(vac.project || '–ë–µ–∑ –ø—Ä–æ–µ–∫—Ç–∞');
            
            const matchDept = this.state.selectedDepartments.length === 0 || 
                this.state.selectedDepartments.includes(vac.department);
            
            const matchSearch = !this.state.searchQuery ||
                (vac.title && vac.title.toLowerCase().includes(this.state.searchQuery)) ||
                (vac.description && vac.description.toLowerCase().includes(this.state.searchQuery));
            
            return matchProject && matchDept && matchSearch;
        });
        
        if (filtered.length === 0) {
            results.innerHTML = `
                <div style="text-align:center; padding: 40px 20px; color: #666;">
                    <p>–í–∞–∫–∞–Ω—Å–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>
                    <p style="font-size:14px; margin-top:8px;">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞</p>
                </div>
            `;
            return;
        }
        
        // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –æ—Ç–¥–µ–ª–∞–º
        const grouped = {};
        filtered.forEach(v => {
            const dept = v.department || '–ë–µ–∑ –æ—Ç–¥–µ–ª–∞';
            if (!grouped[dept]) grouped[dept] = [];
            grouped[dept].push(v);
        });
        
        // –†–µ–Ω–¥–µ—Ä
        results.innerHTML = Object.keys(grouped)
            .sort()
            .map(dept => {
                const vacancies = grouped[dept];
                return `
                    <h2 class="department-header">${dept} <small>(${vacancies.length})</small></h2>
                    ${vacancies.map(vac => `
                        <div class="vacancy-card-wrapper">
                            <a href="/vacancy?id=${vac.id}" class="vacancy-card">
                                <div class="vacancy-content">
                                    <h3>${vac.title}</h3>
                                    <p class="vacancy-meta">${vac.project || '–ë–µ–∑ –ø—Ä–æ–µ–∫—Ç–∞'} ‚Äî ${vac.department}</p>
                                </div>
                                <span class="arrow-icon">‚Üí</span>
                            </a>
                        </div>
                    `).join('')}
                `;
            }).join('');
    }

    updateResetButton() {
        const resetBtn = document.getElementById('reset-all-filters');
        if (resetBtn) {
            const hasFilters = this.state.selectedProjects.length > 0 ||
                              this.state.selectedDepartments.length > 0 ||
                              this.state.searchQuery.trim().length > 0;
            resetBtn.style.display = hasFilters ? 'block' : 'none';
        }
    }

    updateMobileFilters() {
        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –≤ –º–æ–±–∏–ª—å–Ω–æ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
        const projectValue = document.querySelector('.filter-item[data-type="projects"] .filter-value');
        const deptValue = document.querySelector('.filter-item[data-type="departments"] .filter-value');
        
        if (projectValue) {
            projectValue.textContent = this.state.selectedProjects.length
                ? this.state.selectedProjects.join(', ')
                : '–í—Å–µ –ø—Ä–æ–µ–∫—Ç—ã';
        }
        
        if (deptValue) {
            deptValue.textContent = this.state.selectedDepartments.length
                ? this.state.selectedDepartments.join(', ')
                : '–í—Å–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è';
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —á–µ–∫–±–æ–∫—Å—ã –≤ –º–æ–±–∏–ª—å–Ω—ã—Ö dropdown
        this.renderMobileOptions();
    }

    renderMobileOptions() {
        // –ü—Ä–æ–µ–∫—Ç—ã
        const projectOptions = document.getElementById('mobile-project-options');
        if (projectOptions) {
            const values = {};
            this.state.allVacancies.forEach(v => {
                const project = v.project || '–ë–µ–∑ –ø—Ä–æ–µ–∫—Ç–∞';
                values[project] = (values[project] || 0) + 1;
            });
            
            projectOptions.innerHTML = Object.entries(values)
                .sort(([a], [b]) => a.localeCompare(b))
                .map(([project, count]) => {
                    const checked = this.state.selectedProjects.includes(project) ? 'checked' : '';
                    return `
                        <label class="mobile-filter-option">
                            <input type="checkbox" value="${project}" ${checked}>
                            <span>${project} <small>(${count})</small></span>
                        </label>
                    `;
                }).join('');
        }
        
        // –û—Ç–¥–µ–ª—ã
        const deptOptions = document.getElementById('mobile-dept-options');
        if (deptOptions) {
            const values = {};
            this.state.allVacancies.forEach(v => {
                const dept = v.department;
                if (dept) values[dept] = (values[dept] || 0) + 1;
            });
            
            deptOptions.innerHTML = Object.entries(values)
                .sort(([a], [b]) => a.localeCompare(b))
                .map(([dept, count]) => {
                    const checked = this.state.selectedDepartments.includes(dept) ? 'checked' : '';
                    return `
                        <label class="mobile-filter-option">
                            <input type="checkbox" value="${dept}" ${checked}>
                            <span>${dept} <small>(${count})</small></span>
                        </label>
                    `;
                }).join('');
        }
    }

    openMobileFilters() {
        const modal = document.getElementById('mobile-filters-modal');
        if (modal) {
            modal.classList.add('active');
            this.renderMobileOptions();
            
            modal.querySelectorAll('input[type="checkbox"]').forEach(input => {
                input.addEventListener('change', (e) => {
                    const value = e.target.value;
                    const isProject = e.target.closest('#mobile-project-options');
                    
                    if (isProject) {
                        if (e.target.checked) {
                            if (!this.state.selectedProjects.includes(value)) {
                                this.state.selectedProjects.push(value);
                            }
                        } else {
                            this.state.selectedProjects = this.state.selectedProjects.filter(v => v !== value);
                        }
                    } else {
                        if (e.target.checked) {
                            if (!this.state.selectedDepartments.includes(value)) {
                                this.state.selectedDepartments.push(value);
                            }
                        } else {
                            this.state.selectedDepartments = this.state.selectedDepartments.filter(v => v !== value);
                        }
                    }
                    
                    this.updateMobileFilters();
                });
            });
        }
    }

    closeMobileFilters() {
        const modal = document.getElementById('mobile-filters-modal');
        if (modal) modal.classList.remove('active');
    }

    resetFilters() {
        this.state.selectedProjects = [];
        this.state.selectedDepartments = [];
        this.state.searchQuery = '';
        
        const searchInput = document.getElementById('vacancy-search');
        if (searchInput) searchInput.value = '';
        
        if (this.state.placeholderInterval) {
            clearInterval(this.state.placeholderInterval);
            this.state.placeholderInterval = null;
        }
        
        this.renderAll();
        
        if (searchInput && this.state.allVacancies.length > 0) {
            this.startPlaceholderAnimation(searchInput);
        }
    }

    showEmptyState(message) {
        const results = document.getElementById('vacancy-results');
        if (results) {
            results.innerHTML = `
                <div style="text-align:center; padding: 60px 20px; color: #666;">
                    <h3>${message}</h3>
                </div>
            `;
        }
    }

        showError(message) {
        const results = document.getElementById('vacancy-results');
        if (results) {
            results.innerHTML = `
                <div style="text-align:center; padding: 60px 20px; color: #666;">
                    <h3>${message}</h3>
                    <button onclick="location.reload()" style="
                        margin-top: 20px;
                        padding: 12px 24px;
                        background: #048868;
                        color: white;
                        border: none;
                        border-radius: 6px;
                        cursor: pointer;
                    ">–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</button>
                </div>
            `;
        }
    }
}

// === –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
document.addEventListener('DOMContentLoaded', () => {
    console.log('=== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–û–ò–°–ö–ê –í–ê–ö–ê–ù–°–ò–ô ===');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ø–æ–∏—Å–∫–∞
    const container = document.getElementById('vacancy-container');
    if (!container) {
        console.log('‚ÑπÔ∏è –ù–µ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–∏—Å–∫–∞ –≤–∞–∫–∞–Ω—Å–∏–π');
        return;
    }
    
    console.log('‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–∏—Å–∫–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞, –∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ...');
    
    // –°–æ–∑–¥–∞–µ–º –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    window.vacancyListApp = new VacancySearchApp();
    console.log('üöÄ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ:', window.vacancyListApp);
    
    // –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
    setTimeout(() => {
        if (window.vacancyListApp && window.vacancyListApp.state) {
            console.log('üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:', {
                vacanciesCount: window.vacancyListApp.state.allVacancies?.length || 0,
                hasSupabase: !!window.vacancyListApp.state.supabase
            });
        }
    }, 1000);
});
