// vacancies.min.js - –§–ò–ù–ê–õ–¨–ù–ê–Ø –†–ê–ë–û–ß–ê–Ø –í–ï–†–°–ò–Ø
// –ü—Ä–æ—Å—Ç–æ–π –ø–æ–∏—Å–∫ –≤–∞–∫–∞–Ω—Å–∏–π –±–µ–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

console.log('üéØ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∏—Å–∫–∞ –≤–∞–∫–∞–Ω—Å–∏–π');

class VacancySearchApp {
    constructor() {
        this.state = {
            allVacancies: [],
            selectedProjects: [],
            selectedDepartments: [],
            searchQuery: '',
            placeholderInterval: null
        };
        
        this.init();
    }

    async init() {
        console.log('üîç –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...');
        
        try {
            // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            await this.loadData();
            
            // 2. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            this.setupUI();
            
            // 3. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            this.renderAll();
            
            console.log('‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ');
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
            this.showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∏—Å—Ç–µ–º—ã');
        }
    }

    async loadData() {
        console.log('üì° –ó–∞–≥—Ä—É–∑–∫–∞ –≤–∞–∫–∞–Ω—Å–∏–π...');
        
        const url = 'https://vhbiezamhpyejdqvvwuj.supabase.co/rest/v1/vacancies?select=id,title,project,department,description&status=eq.active&order=created_at.desc';
        const key = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZoYmllemFtaHB5ZWpkcXZ2d3VqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE2Njc0MDgsImV4cCI6MjA3NzI0MzQwOH0.13h_XJ7kQFtuCjavkOXN9TzXNF2X4jX5-rcNCFiFqO0';
        
        try {
            const response = await fetch(url, {
                headers: {
                    'apikey': key,
                    'Authorization': `Bearer ${key}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            const data = await response.json();
            
            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
            this.state.allVacancies = data.map(item => ({
                id: item.id,
                title: item.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è',
                project: item.project || '–ë–µ–∑ –ø—Ä–æ–µ–∫—Ç–∞',
                department: item.department || '–ë–µ–∑ –æ—Ç–¥–µ–ª–∞',
                description: item.description || ''
            }));
            
            console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${this.state.allVacancies.length} –≤–∞–∫–∞–Ω—Å–∏–π`);
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
            throw error;
        }
    }

    setupUI() {
        console.log('‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞...');
        
        // –ü–æ–∏—Å–∫
        const searchInput = document.getElementById('vacancy-search');
        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                this.state.searchQuery = e.target.value.toLowerCase().trim();
                this.renderResults();
                this.updateResetButton();
            });
            
            // –ê–Ω–∏–º–∞—Ü–∏—è placeholder
            this.startPlaceholderAnimation(searchInput);
        }
        
        // –î–µ—Å–∫—Ç–æ–ø–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
        this.setupDesktopFilters();
        
        // –ú–æ–±–∏–ª—å–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
        this.setupMobileFilters();
        
        // –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞
        const resetBtn = document.getElementById('reset-all-filters');
        if (resetBtn) {
            resetBtn.addEventListener('click', () => this.resetFilters());
        }
    }

    setupDesktopFilters() {
        // –ü—Ä–æ–µ–∫—Ç—ã
        const projectFilter = document.getElementById('project-filter');
        if (projectFilter) {
            const header = projectFilter.querySelector('.select-header');
            const clearBtn = projectFilter.querySelector('.clear-btn');
            
            if (header) {
                header.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.toggleFilter('project');
                });
            }
            
            if (clearBtn) {
                clearBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.state.selectedProjects = [];
                    this.renderAll();
                });
            }
        }
        
        // –û—Ç–¥–µ–ª—ã
        const deptFilter = document.getElementById('department-filter');
        if (deptFilter) {
            const header = deptFilter.querySelector('.select-header');
            const clearBtn = deptFilter.querySelector('.clear-btn');
            
            if (header) {
                header.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.toggleFilter('department');
                });
            }
            
            if (clearBtn) {
                clearBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.state.selectedDepartments = [];
                    this.renderAll();
                });
            }
        }
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
        document.addEventListener('click', () => {
            document.querySelectorAll('.custom-select').forEach(el => {
                el.classList.remove('active');
            });
        });
    }

    setupMobileFilters() {
        const mobileBtn = document.getElementById('mobile-filters-btn');
        const mobileModal = document.getElementById('mobile-filters-modal');
        
        if (mobileBtn && mobileModal) {
            mobileBtn.addEventListener('click', () => {
                mobileModal.classList.add('active');
                this.renderMobileOptions();
            });
            
            mobileModal.addEventListener('click', (e) => {
                if (e.target === mobileModal) {
                    mobileModal.classList.remove('active');
                }
            });
        }
        
        // –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
        const applyBtn = document.getElementById('apply-mobile-filters');
        if (applyBtn) {
            applyBtn.addEventListener('click', () => {
                this.renderAll();
                document.getElementById('mobile-filters-modal').classList.remove('active');
            });
        }
    }

    toggleFilter(type) {
        const filterId = type === 'project' ? 'project-filter' : 'department-filter';
        const filter = document.getElementById(filterId);
        if (!filter) return;
        
        const isActive = filter.classList.contains('active');
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –¥—Ä—É–≥–∏–µ
        document.querySelectorAll('.custom-select').forEach(el => {
            if (el.id !== filterId) el.classList.remove('active');
        });
        
        // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ç–µ–∫—É—â–∏–π
        filter.classList.toggle('active', !isActive);
        
        // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã–ª–∏ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–ø—Ü–∏–∏
        if (!isActive) {
            this.renderFilterOptions(type);
        }
    }

    renderFilterOptions(type) {
        const isProject = type === 'project';
        const filterId = isProject ? 'project-filter' : 'department-filter';
        const selected = isProject ? this.state.selectedProjects : this.state.selectedDepartments;
        
        const filter = document.getElementById(filterId);
        if (!filter) return;
        
        const dropdown = filter.querySelector('.select-dropdown');
        if (!dropdown) return;
        
        // –°–æ–±–∏—Ä–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
        const values = {};
        this.state.allVacancies.forEach(v => {
            const key = isProject ? v.project : v.department;
            if (key) values[key] = (values[key] || 0) + 1;
        });
        
        // –†–µ–Ω–¥–µ—Ä–∏–º –æ–ø—Ü–∏–∏
        dropdown.innerHTML = Object.entries(values)
            .sort(([a], [b]) => a.localeCompare(b))
            .map(([value, count]) => {
                const checked = selected.includes(value) ? 'checked' : '';
                return `
                    <label class="select-option">
                        <input type="checkbox" value="${value}" ${checked}>
                        <span>${value} <small>(${count})</small></span>
                    </label>
                `;
            }).join('');
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        dropdown.querySelectorAll('input').forEach(input => {
            input.addEventListener('change', (e) => {
                const value = e.target.value;
                
                if (isProject) {
                    if (e.target.checked) {
                        if (!this.state.selectedProjects.includes(value)) {
                            this.state.selectedProjects.push(value);
                        }
                    } else {
                        this.state.selectedProjects = this.state.selectedProjects.filter(v => v !== value);
                    }
                } else {
                    if (e.target.checked) {
                        if (!this.state.selectedDepartments.includes(value)) {
                            this.state.selectedDepartments.push(value);
                        }
                    } else {
                        this.state.selectedDepartments = this.state.selectedDepartments.filter(v => v !== value);
                    }
                }
                
                this.renderAll();
            });
        });
    }

    startPlaceholderAnimation(input) {
        if (this.state.allVacancies.length === 0) return;
        
        const titles = this.state.allVacancies
            .map(v => v.title)
            .filter(t => t && t.trim())
            .slice(0, 8);
        
        if (titles.length === 0) return;
        
        let i = 0;
        const update = () => {
            input.placeholder = titles[i] || '–ù–∞–∑–≤–∞–Ω–∏–µ –≤–∞–∫–∞–Ω—Å–∏–∏';
            i = (i + 1) % titles.length;
        };
        
        update();
        
        if (this.state.placeholderInterval) {
            clearInterval(this.state.placeholderInterval);
        }
        
        this.state.placeholderInterval = setInterval(update, 1500);
    }

    renderAll() {
        this.renderFilterLabels();
        this.renderResults();
        this.updateResetButton();
    }

    renderFilterLabels() {
        // –ü—Ä–æ–µ–∫—Ç—ã
        const projectLabel = document.querySelector('#project-filter .selected-values');
        if (projectLabel) {
            projectLabel.textContent = this.state.selectedProjects.length 
                ? this.state.selectedProjects.join(', ')
                : '–í—Å–µ –ø—Ä–æ–µ–∫—Ç—ã';
            
            const filter = document.getElementById('project-filter');
            if (filter) {
                filter.classList.toggle('has-selection', this.state.selectedProjects.length > 0);
            }
        }
        
        // –û—Ç–¥–µ–ª—ã
        const deptLabel = document.querySelector('#department-filter .selected-values');
        if (deptLabel) {
            deptLabel.textContent = this.state.selectedDepartments.length 
                ? this.state.selectedDepartments.join(', ')
                : '–í—Å–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è';
            
            const filter = document.getElementById('department-filter');
            if (filter) {
                filter.classList.toggle('has-selection', this.state.selectedDepartments.length > 0);
            }
        }
    }

    renderResults() {
        const results = document.getElementById('vacancy-results');
        if (!results) return;
        
        if (this.state.allVacancies.length === 0) {
            results.innerHTML = `
                <div style="text-align:center; padding: 40px; color: #666;">
                    <p>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤–∞–∫–∞–Ω—Å–∏–π</p>
                </div>
            `;
            return;
        }
        
        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è
        const filtered = this.state.allVacancies.filter(vac => {
            const matchProject = this.state.selectedProjects.length === 0 || 
                this.state.selectedProjects.includes(vac.project);
            
            const matchDept = this.state.selectedDepartments.length === 0 || 
                this.state.selectedDepartments.includes(vac.department);
            
            const matchSearch = !this.state.searchQuery ||
                vac.title.toLowerCase().includes(this.state.searchQuery) ||
                (vac.description && vac.description.toLowerCase().includes(this.state.searchQuery));
            
            return matchProject && matchDept && matchSearch;
        });
        
        if (filtered.length === 0) {
            results.innerHTML = `
                <div style="text-align:center; padding: 40px; color: #666;">
                    <p>–í–∞–∫–∞–Ω—Å–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>
                    <p style="font-size:14px; margin-top:8px;">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞</p>
                </div>
            `;
            return;
        }
        
        // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –æ—Ç–¥–µ–ª–∞–º
        const grouped = {};
        filtered.forEach(v => {
            const dept = v.department || '–ë–µ–∑ –æ—Ç–¥–µ–ª–∞';
            if (!grouped[dept]) grouped[dept] = [];
            grouped[dept].push(v);
        });
        
        // –†–µ–Ω–¥–µ—Ä
        results.innerHTML = Object.keys(grouped)
            .sort()
            .map(dept => {
                const vacancies = grouped[dept];
                return `
                    <h2 class="department-header">${dept} <small>(${vacancies.length})</small></h2>
                    ${vacancies.map(vac => `
                        <div class="vacancy-card-wrapper">
                            <a href="/vacancy?id=${vac.id}" class="vacancy-card">
                                <div class="vacancy-content">
                                    <h3>${vac.title}</h3>
                                    <p class="vacancy-meta">${vac.project} ‚Äî ${vac.department}</p>
                                </div>
                                <span class="arrow-icon">‚Üí</span>
                            </a>
                        </div>
                    `).join('')}
                `;
            }).join('');
    }

    updateResetButton() {
        const resetBtn = document.getElementById('reset-all-filters');
        if (resetBtn) {
            const hasFilters = this.state.selectedProjects.length > 0 ||
                              this.state.selectedDepartments.length > 0 ||
                              this.state.searchQuery.trim().length > 0;
            resetBtn.style.display = hasFilters ? 'block' : 'none';
        }
    }

    renderMobileOptions() {
        // –ü—Ä–æ–µ–∫—Ç—ã –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
        const projectOptions = document.getElementById('mobile-project-options');
        if (projectOptions) {
            const values = {};
            this.state.allVacancies.forEach(v => {
                values[v.project] = (values[v.project] || 0) + 1;
            });
            
            projectOptions.innerHTML = Object.entries(values)
                .map(([project, count]) => {
                    const checked = this.state.selectedProjects.includes(project) ? 'checked' : '';
                    return `
                        <label class="mobile-filter-option">
                            <input type="checkbox" value="${project}" ${checked}>
                            <span>${project} <small>(${count})</small></span>
                        </label>
                    `;
                }).join('');
        }
        
        // –û—Ç–¥–µ–ª—ã –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
        const deptOptions = document.getElementById('mobile-dept-options');
        if (deptOptions) {
            const values = {};
            this.state.allVacancies.forEach(v => {
                values[v.department] = (values[v.department] || 0) + 1;
            });
            
            deptOptions.innerHTML = Object.entries(values)
                .map(([dept, count]) => {
                    const checked = this.state.selectedDepartments.includes(dept) ? 'checked' : '';
                    return `
                        <label class="mobile-filter-option">
                            <input type="checkbox" value="${dept}" ${checked}>
                            <span>${dept} <small>(${count})</small></span>
                        </label>
                    `;
                }).join('');
        }
    }

    resetFilters() {
        this.state.selectedProjects = [];
        this.state.selectedDepartments = [];
        this.state.searchQuery = '';
        
        const searchInput = document.getElementById('vacancy-search');
        if (searchInput) searchInput.value = '';
        
        if (this.state.placeholderInterval) {
            clearInterval(this.state.placeholderInterval);
            this.state.placeholderInterval = null;
        }
        
        this.renderAll();
        
        if (searchInput && this.state.allVacancies.length > 0) {
            this.startPlaceholderAnimation(searchInput);
        }
    }

    showError(message) {
        const results = document.getElementById('vacancy-results');
        if (results) {
            results.innerHTML = `
                <div style="text-align:center; padding: 60px 20px; color: #666;">
                    <h3>${message}</h3>
                    <button onclick="location.reload()" style="
                        margin-top: 20px;
                        padding: 12px 24px;
                        background: #048868;
                        color: white;
                        border: none;
                        border-radius: 6px;
                        cursor: pointer;
                    ">–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</button>
                </div>
            `;
        }
    }
}

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener('DOMContentLoaded', () => {
    console.log('üöÄ DOM –≥–æ—Ç–æ–≤, –∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ...');
    
    if (document.getElementById('vacancy-container')) {
        window.vacancyListApp = new VacancySearchApp();
        console.log('‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ');
    } else {
        console.log('‚ÑπÔ∏è –ù–µ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–∏—Å–∫–∞ –≤–∞–∫–∞–Ω—Å–∏–π');
    }
});
