name: Fetch FriendWork Jobs Full

on:
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * *'

jobs:
  fetch-jobs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Debug FriendWork API response
        run: |
          echo "üîç –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å (–æ–¥–Ω–∞ –≤–∞–∫–∞–Ω—Å–∏—è):"
          curl -s --request GET \
            --header 'Accept: application/json' \
            --header 'Content-Type: application/json' \
            --header "Authorization: Bearer ${{ secrets.FRIENDWORK_API_TOKEN }}" \
            --data "{\"statuses\": [\"open\", \"onHold\"], \"paging\": { \"page\": 0, \"count\": 1 }}" \
            'https://api.friend.work/jobs' | jq '.'

      - name: Fetch all FriendWork jobs and details
        run: |
          page=0
          count=50
          jobids=()
          
          while :; do
            echo "üîÑ –ó–∞–≥—Ä—É–∂–∞—é —Å—Ç—Ä–∞–Ω–∏—Ü—É $page..."
            
            resp=$(curl -s --request GET \
              --header 'Accept: application/json' \
              --header 'Content-Type: application/json' \
              --header "Authorization: Bearer ${{ secrets.FRIENDWORK_API_TOKEN }}" \
              --data "{\"statuses\": [\"open\", \"onHold\"], \"paging\": { \"page\": $page, \"count\": $count }}" \
              'https://api.friend.work/jobs')
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –æ—Ç–≤–µ—Ç–∞
            items=$(echo "$resp" | jq '.Items')
            
            # –ï—Å–ª–∏ Items –Ω–µ—Ç, –ø—Ä–æ–±—É–µ–º –¥—Ä—É–≥–∏–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è
            if [ "$items" = "null" ]; then
              items=$(echo "$resp" | jq '.items // .data // .jobs // []')
            fi
            
            n=$(echo "$items" | jq 'length')
            echo "  –ù–∞–π–¥–µ–Ω–æ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ: $n"
            
            if [ "$n" -eq 0 ]; then
              break
            fi
            
            # –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –Ω–∞–∑–≤–∞–Ω–∏—è ID
            ids=$(echo "$items" | jq -r '.[].jobId // .[].id // .[].job_id // empty')
            
            for id in $ids; do
              if [ ! -z "$id" ] && [ "$id" != "null" ]; then
                jobids+=($id)
                echo "  + –î–æ–±–∞–≤–ª–µ–Ω jobId: $id"
              fi
            done
            
            page=$((page+1))
            
            # –ï—Å–ª–∏ –ø–æ–ª—É—á–∏–ª–∏ –º–µ–Ω—å—à–µ —á–µ–º –∑–∞–ø—Ä–∞—à–∏–≤–∞–ª–∏ - —ç—Ç–æ –ø–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
            if [ "$n" -lt "$count" ]; then
              break
            fi
          done
          
          echo "‚úÖ –í—Å–µ–≥–æ –Ω–∞–π–¥–µ–Ω–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö jobId: ${#jobids[@]}"
          
          if [ ${#jobids[@]} -eq 0 ]; then
            echo "‚ùå –ù–µ—Ç –≤–∞–∫–∞–Ω—Å–∏–π –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏. –°–æ–∑–¥–∞—é –ø—É—Å—Ç–æ–π —Ñ–∞–π–ª."
            echo '[]' > Beliy_Mys_VAC/jobs_full.json
            exit 0
          fi
          
          # –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–µ—Ç–∞–ª–∏ –∫–∞–∂–¥–æ–π –≤–∞–∫–∞–Ω—Å–∏–∏
          details=()
          success_count=0
          
          for jobid in "${jobids[@]}"; do
            echo "üîÑ –ó–∞–≥—Ä—É–∂–∞—é –¥–µ—Ç–∞–ª–∏ –≤–∞–∫–∞–Ω—Å–∏–∏ $jobid... ($((success_count+1))/${#jobids[@]})"
            
            detail=$(curl -s -X GET \
              --header 'Accept: application/json' \
              --header "Authorization: Bearer ${{ secrets.FRIENDWORK_API_TOKEN }}" \
              "https://api.friend.work/jobs/$jobid")
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –≤–∞–ª–∏–¥–Ω—ã–π JSON –∏ –Ω–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
            if echo "$detail" | jq empty 2>/dev/null; then
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø–æ–ª—è —Å –æ—à–∏–±–∫–æ–π
              if ! echo "$detail" | jq -e '.error' > /dev/null 2>&1; then
                details+=("$detail")
                success_count=$((success_count+1))
                echo "  ‚úÖ –£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ"
              else
                echo "  ‚ùå –û—à–∏–±–∫–∞ –æ—Ç API: $(echo "$detail" | jq -r '.error.message // .error')"
              fi
            else
              echo "  ‚ùå –ù–µ–≤–∞–ª–∏–¥–Ω—ã–π JSON –æ—Ç–≤–µ—Ç"
            fi
          done
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ –¥–µ—Ç–∞–ª–∏
          if [ ${#details[@]} -gt 0 ]; then
            printf '%s\n' "${details[@]}" | jq -s '.' > Beliy_Mys_VAC/jobs_full.json
            echo "‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ${#details[@]} –≤–∞–∫–∞–Ω—Å–∏–π –≤ jobs_full.json"
            
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            echo ""
            echo "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø–æ–ª—è–º:"
            jq -r '.[0] | keys | .[]' Beliy_Mys_VAC/jobs_full.json | while read key; do
              count=$(jq --arg key "$key" '[.[] | has($key)] | map(select(.)) | length' Beliy_Mys_VAC/jobs_full.json)
              echo "  –ü–æ–ª–µ '$key': –µ—Å—Ç—å —É $count –∏–∑ ${#details[@]} –≤–∞–∫–∞–Ω—Å–∏–π"
            done
          else
            echo "‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è"
            echo '[]' > Beliy_Mys_VAC/jobs_full.json
          fi

      - name: Upload jobs_full.json
        uses: actions/upload-artifact@v4
        with:
          name: friendwork-jobs-full
          path: Beliy_Mys_VAC/jobs_full.json

      - name: Debug jobs_full.json
        run: |
          echo "üìä –°–æ–¥–µ—Ä–∂–∏–º–æ–µ jobs_full.json:"
          if [ -f Beliy_Mys_VAC/jobs_full.json ]; then
            count=$(jq length Beliy_Mys_VAC/jobs_full.json)
            echo "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∞–∫–∞–Ω—Å–∏–π: $count"
            if [ "$count" -gt 0 ]; then
              echo "–ü–µ—Ä–≤–∞—è –≤–∞–∫–∞–Ω—Å–∏—è:"
              jq '.[0] | {jobId: .jobId, title: .name, has_req: has("requirements"), has_resp: has("responsibilities"), has_cond: has("conditions")}' Beliy_Mys_VAC/jobs_full.json
            fi
          else
            echo "‚ùå –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω"
          fi

      - name: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Python –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
        run: |
          python -m pip install --upgrade pip
          pip install pandas requests

      - name: –≠–∫—Å–ø–æ—Ä—Ç –¥–ª—è Supabase
        run: python export_to_supabase.py
        working-directory: ${{ github.workspace }}/Beliy_Mys_VAC

      - name: –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤ vacancies_rows.csv
        run: python convert_to_vacancies_rows.py
        working-directory: ${{ github.workspace }}/Beliy_Mys_VAC

      - name: Upload jobs_supabase.csv
        uses: actions/upload-artifact@v4
        with:
          name: friendwork-jobs-supabase
          path: Beliy_Mys_VAC/jobs_supabase.csv

      - name: Upload vacancies_rows.csv
        uses: actions/upload-artifact@v4
        with:
          name: friendwork-vacancies-rows
          path: Beliy_Mys_VAC/vacancies_rows.csv

      - name: –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ Supabase
        run: python upload_to_supabase.py
        working-directory: ${{ github.workspace }}/Beliy_Mys_VAC
