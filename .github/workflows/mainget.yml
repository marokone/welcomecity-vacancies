name: Fetch FriendWork Jobs Full

on:
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * *'

jobs:
  fetch-jobs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Debug FriendWork API response
        run: |
          resp=$(curl -s --request GET \
            --header 'Accept: application/json' \
            --header 'Content-Type: application/json' \
            --header "Authorization: Bearer ${{ secrets.FRIENDWORK_API_TOKEN }}" \
            --data "{\"statuses\": [\"open\", \"onHold\"], \"paging\": { \"page\": 0, \"count\": 1 }}" \
            'https://api.friend.work/jobs')
          echo "$resp"

      - name: Fetch all FriendWork jobs and details
        run: |
          page=0
          count=50
          jobids=()
          while :; do
            resp=$(curl -s --request GET \
              --header 'Accept: application/json' \
              --header 'Content-Type: application/json' \
              --header "Authorization: Bearer ${{ secrets.FRIENDWORK_API_TOKEN }}" \
              --data "{\"statuses\": [\"open\", \"onHold\"], \"paging\": { \"page\": $page, \"count\": $count }}" \
              'https://api.friend.work/jobs')
            items=$(echo "$resp" | jq '.Items')
            n=$(echo "$items" | jq 'length')
            if [ "$n" -eq 0 ]; then
              break
            fi
            ids=$(echo "$items" | jq -r '.[].jobId')
            for id in $ids; do
              jobids+=($id)
            done
            page=$((page+1))
          done
          echo "‚úÖ –ù–∞–π–¥–µ–Ω–æ –≤–∞–∫–∞–Ω—Å–∏–π: ${#jobids[@]}"
          
          details=()
          for jobid in "${jobids[@]}"; do
            echo "üîÑ –ó–∞–≥—Ä—É–∂–∞—é –¥–µ—Ç–∞–ª–∏ –≤–∞–∫–∞–Ω—Å–∏–∏ $jobid..."
            detail=$(curl -s -X GET \
              --header 'Accept: application/json' \
              --header "Authorization: Bearer ${{ secrets.FRIENDWORK_API_TOKEN }}" \
              "https://api.friend.work/jobs/$jobid")
            if echo "$detail" | jq empty 2>/dev/null; then
              details+=("$detail")
            fi
          done
          printf '%s\n' "${details[@]}" | jq -s '.' > Beliy_Mys_VAC/jobs_full.json

      # üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê - –ß–¢–û –ü–û–õ–£–ß–ò–õ–ò –û–¢ API
      - name: üîç –ü–†–û–í–ï–†–ö–ê –î–ê–ù–ù–´–• –ò–ó API
        run: |
          echo "===================================="
          echo "üîç –ê–ù–ê–õ–ò–ó –û–¢–í–ï–¢–ê API"
          echo "===================================="
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ñ–∞–π–ª
          if [ ! -f Beliy_Mys_VAC/jobs_full.json ]; then
            echo "‚ùå –§–∞–π–ª jobs_full.json –ù–ï –°–û–ó–î–ê–ù!"
            exit 1
          fi
          
          # –°–º–æ—Ç—Ä–∏–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞
          echo "üìä –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: $(wc -l < Beliy_Mys_VAC/jobs_full.json) —Å—Ç—Ä–æ–∫"
          
          # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∞–∫–∞–Ω—Å–∏–π
          count=$(jq length Beliy_Mys_VAC/jobs_full.json)
          echo "üìä –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∞–∫–∞–Ω—Å–∏–π –≤ —Ñ–∞–π–ª–µ: $count"
          
          if [ "$count" -eq "0" ]; then
            echo "‚ùå –§–∞–π–ª –ø—É—Å—Ç! –í–∞–∫–∞–Ω—Å–∏–π –Ω–µ—Ç."
            echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞:"
            cat Beliy_Mys_VAC/jobs_full.json
          else
            echo "‚úÖ –ù–∞–π–¥–µ–Ω–æ –≤–∞–∫–∞–Ω—Å–∏–π: $count"
            echo ""
            echo "üìã –ü–ï–†–í–ê–Ø –í–ê–ö–ê–ù–°–ò–Ø (–ø–æ–ª–Ω–æ—Å—Ç—å—é):"
            echo "----------------------------------------"
            jq '.[0]' Beliy_Mys_VAC/jobs_full.json
            
            echo ""
            echo "üîë –í–°–ï –ü–û–õ–Ø –ü–ï–†–í–û–ô –í–ê–ö–ê–ù–°–ò–ò:"
            echo "----------------------------------------"
            jq '.[0] | keys' Beliy_Mys_VAC/jobs_full.json
            
            echo ""
            echo "üìù –ü–û–ò–°–ö –ù–£–ñ–ù–´–• –ü–û–õ–ï–ô:"
            echo "----------------------------------------"
            echo "–ü–æ–ª—è —Å 'description':"
            jq '.[0] | with_entries(select(.key | contains("description")))' Beliy_Mys_VAC/jobs_full.json
            
            echo ""
            echo "–ü–æ–ª—è —Å 'requirement':"
            jq '.[0] | with_entries(select(.key | contains("requirement")))' Beliy_Mys_VAC/jobs_full.json
            
            echo ""
            echo "–ü–æ–ª—è —Å 'responsibilit':"
            jq '.[0] | with_entries(select(.key | contains("responsibilit")))' Beliy_Mys_VAC/jobs_full.json
            
            echo ""
            echo "–ü–æ–ª—è —Å 'condition':"
            jq '.[0] | with_entries(select(.key | contains("condition")))' Beliy_Mys_VAC/jobs_full.json
          fi

      - name: Upload jobs_full.json
        uses: actions/upload-artifact@v4
        with:
          name: friendwork-jobs-full
          path: Beliy_Mys_VAC/jobs_full.json

      - name: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Python –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
        run: |
          python -m pip install --upgrade pip
          pip install pandas requests

      - name: –≠–∫—Å–ø–æ—Ä—Ç –¥–ª—è Supabase
        run: |
          python export_to_supabase.py
          echo "‚úÖ –ü–æ—Å–ª–µ export_to_supabase.py:"
          if [ -f Beliy_Mys_VAC/jobs_supabase.csv ]; then
            echo "üìä jobs_supabase.csv —Å–æ–∑–¥–∞–Ω"
            echo "üìä –ü–µ—Ä–≤—ã–µ 5 —Å—Ç—Ä–æ–∫:"
            head -5 Beliy_Mys_VAC/jobs_supabase.csv
          else
            echo "‚ùå jobs_supabase.csv –ù–ï —Å–æ–∑–¥–∞–Ω!"
          fi
        working-directory: ${{ github.workspace }}/Beliy_Mys_VAC

      - name: –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤ vacancies_rows.csv
        run: |
          python convert_to_vacancies_rows.py
          echo "‚úÖ –ü–æ—Å–ª–µ convert_to_vacancies_rows.py:"
          if [ -f Beliy_Mys_VAC/vacancies_rows.csv ]; then
            echo "üìä vacancies_rows.csv —Å–æ–∑–¥–∞–Ω"
            echo "üìä –ü–µ—Ä–≤—ã–µ 5 —Å—Ç—Ä–æ–∫:"
            head -5 Beliy_Mys_VAC/vacancies_rows.csv
            echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ requirements/responsibilities/conditions:"
            tail -n +2 Beliy_Mys_VAC/vacancies_rows.csv | cut -d',' -f6,7,8 | head -5
          else
            echo "‚ùå vacancies_rows.csv –ù–ï —Å–æ–∑–¥–∞–Ω!"
          fi
        working-directory: ${{ github.workspace }}/Beliy_Mys_VAC

      - name: Upload jobs_supabase.csv
        uses: actions/upload-artifact@v4
        with:
          name: friendwork-jobs-supabase
          path: Beliy_Mys_VAC/jobs_supabase.csv

      - name: Upload vacancies_rows.csv
        uses: actions/upload-artifact@v4
        with:
          name: friendwork-vacancies-rows
          path: Beliy_Mys_VAC/vacancies_rows.csv

      - name: –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ Supabase
        run: |
          python upload_to_supabase.py
          echo "‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ –≤ Supabase –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
        working-directory: ${{ github.workspace }}/Beliy_Mys_VAC
