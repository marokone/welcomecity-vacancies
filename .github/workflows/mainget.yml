name: Fetch FriendWork Jobs Full

on:
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * *'

jobs:
  fetch-jobs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Debug FriendWork API response
        run: |
          resp=$(curl -s --request GET \
            --header 'Accept: application/json' \
            --header 'Content-Type: application/json' \
            --header "Authorization: Bearer ${{ secrets.FRIENDWORK_API_TOKEN }}" \
            --data "{\"statuses\": [\"open\", \"onHold\"], \"paging\": { \"page\": 0, \"count\": 1 }}" \
            'https://api.friend.work/jobs')
          echo "$resp"

      - name: Fetch all FriendWork jobs and details
        run: |
          page=0
          count=50
          jobids=()
          
          echo "üîÑ –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É —Å–ø–∏—Å–∫–∞ –≤–∞–∫–∞–Ω—Å–∏–π..."
          
          while :; do
            resp=$(curl -s --request GET \
              --header 'Accept: application/json' \
              --header 'Content-Type: application/json' \
              --header "Authorization: Bearer ${{ secrets.FRIENDWORK_API_TOKEN }}" \
              --data "{\"statuses\": [\"open\", \"onHold\"], \"paging\": { \"page\": $page, \"count\": $count }}" \
              'https://api.friend.work/jobs')
            
            items=$(echo "$resp" | jq '.Items')
            n=$(echo "$items" | jq 'length')
            
            echo "  –°—Ç—Ä–∞–Ω–∏—Ü–∞ $page: –Ω–∞–π–¥–µ–Ω–æ $n –≤–∞–∫–∞–Ω—Å–∏–π"
            
            if [ "$n" -eq 0 ]; then
              break
            fi
            
            ids=$(echo "$items" | jq -r '.[].jobId')
            for id in $ids; do
              jobids+=($id)
            done
            
            page=$((page+1))
          done

          echo "‚úÖ –í—Å–µ–≥–æ –Ω–∞–π–¥–µ–Ω–æ –≤–∞–∫–∞–Ω—Å–∏–π: ${#jobids[@]}"

          if [ ${#jobids[@]} -eq 0 ]; then
            echo "‚ùå –ù–µ—Ç –≤–∞–∫–∞–Ω—Å–∏–π –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏"
            echo '[]' > Beliy_Mys_VAC/jobs_full.json
            exit 0
          fi

          # –ü—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–± —Å–æ–∑–¥–∞–Ω–∏—è JSON (–∫–∞–∫ –≤ —Ä–∞–±–æ—á–µ–º main.yml)
          echo "üîÑ –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–µ—Ç–∞–ª–∏ –≤–∞–∫–∞–Ω—Å–∏–π..."
          echo '[' > Beliy_Mys_VAC/jobs_full.json
          first=1
          total=${#jobids[@]}
          current=0
          
          for jobid in "${jobids[@]}"; do
            current=$((current+1))
            echo "  –ó–∞–≥—Ä—É–∂–∞—é $current –∏–∑ $total: –≤–∞–∫–∞–Ω—Å–∏—è $jobid"
            
            detail=$(curl -s -X GET \
              --header 'Accept: application/json' \
              --header "Authorization: Bearer ${{ secrets.FRIENDWORK_API_TOKEN }}" \
              "https://api.friend.work/jobs/$jobid")
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –æ—Ç–≤–µ—Ç –≤–∞–ª–∏–¥–Ω—ã–π
            if echo "$detail" | jq empty 2>/dev/null; then
              if [ $first -eq 1 ]; then
                first=0
              else
                echo ',' >> Beliy_Mys_VAC/jobs_full.json
              fi
              echo "$detail" >> Beliy_Mys_VAC/jobs_full.json
              echo "    ‚úÖ –£—Å–ø–µ—à–Ω–æ"
            else
              echo "    ‚ùå –û—à–∏–±–∫–∞: –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π JSON"
            fi
          done
          echo ']' >> Beliy_Mys_VAC/jobs_full.json
          
          echo "‚úÖ –ì–æ—Ç–æ–≤–æ: Beliy_Mys_VAC/jobs_full.json"

      - name: Upload jobs_full.json
        uses: actions/upload-artifact@v4
        with:
          name: friendwork-jobs-full
          path: Beliy_Mys_VAC/jobs_full.json

      - name: Debug jobs_full.json
        run: |
          echo "üìä –°–æ–¥–µ—Ä–∂–∏–º–æ–µ jobs_full.json:"
          if [ -f Beliy_Mys_VAC/jobs_full.json ]; then
            count=$(jq length Beliy_Mys_VAC/jobs_full.json)
            echo "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∞–∫–∞–Ω—Å–∏–π: $count"
            if [ "$count" -gt 0 ]; then
              echo "–ü–µ—Ä–≤–∞—è –≤–∞–∫–∞–Ω—Å–∏—è (–ø–µ—Ä–≤—ã–µ 500 —Å–∏–º–≤–æ–ª–æ–≤):"
              jq '.[0]' Beliy_Mys_VAC/jobs_full.json | head -c 500
              
              echo ""
              echo "üîë –ü–æ–ª—è –ø–µ—Ä–≤–æ–π –≤–∞–∫–∞–Ω—Å–∏–∏:"
              jq '.[0] | keys' Beliy_Mys_VAC/jobs_full.json
            else
              echo "‚ùå –§–∞–π–ª –ø—É—Å—Ç"
              cat Beliy_Mys_VAC/jobs_full.json
            fi
          else
            echo "‚ùå –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω"
          fi

      - name: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Python –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
        run: |
          python -m pip install --upgrade pip
          pip install beautifulsoup4 lxml pandas requests

      - name: –ü–∞—Ä—Å–∏–Ω–≥ –æ–ø–∏—Å–∞–Ω–∏–π –≤–∞–∫–∞–Ω—Å–∏–π
        run: python -u parse_descriptions.py
        working-directory: ${{ github.workspace }}/Beliy_Mys_VAC

      - name: –≠–∫—Å–ø–æ—Ä—Ç –¥–ª—è Supabase
        run: python export_to_supabase.py
        working-directory: ${{ github.workspace }}/Beliy_Mys_VAC

      - name: –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤ vacancies_rows.csv
        run: python convert_to_vacancies_rows.py
        working-directory: ${{ github.workspace }}/Beliy_Mys_VAC

      - name: Upload jobs_supabase.csv
        uses: actions/upload-artifact@v4
        with:
          name: friendwork-jobs-supabase
          path: Beliy_Mys_VAC/jobs_supabase.csv

      - name: –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ Supabase
        run: python upload_to_supabase.py
        working-directory: ${{ github.workspace }}/Beliy_Mys_VAC

      - name: Upload vacancies_rows.csv
        uses: actions/upload-artifact@v4
        with:
          name: friendwork-vacancies-rows
          path: Beliy_Mys_VAC/vacancies_rows.csv

      - name: Upload jobs_structured.json
        uses: actions/upload-artifact@v4
        with:
          name: friendwork-jobs-structured
          path: Beliy_Mys_VAC/jobs_structured.json
