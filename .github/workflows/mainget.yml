name: Fetch FriendWork Jobs Full

on:
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * *'

jobs:
  fetch-jobs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # üîç –¢–ï–°–¢ 1: –°–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π GET –∑–∞–ø—Ä–æ—Å
      - name: üîç –¢–ï–°–¢ 1 - GET –±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        run: |
          echo "===================================="
          echo "üîç –¢–ï–°–¢ 1: –ü—Ä–æ—Å—Ç–æ–π GET –∑–∞–ø—Ä–æ—Å"
          echo "===================================="
          curl -v -X GET \
            --header 'Accept: application/json' \
            --header "Authorization: Bearer ${{ secrets.FRIENDWORK_API_TOKEN }}" \
            'https://api.friend.work/jobs'
          echo ""
          echo "===================================="

      # üîç –¢–ï–°–¢ 2: GET —Å –ø—É—Å—Ç—ã–º —Ç–µ–ª–æ–º
      - name: üîç –¢–ï–°–¢ 2 - GET —Å –ø—É—Å—Ç—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
        run: |
          echo "===================================="
          echo "üîç –¢–ï–°–¢ 2: GET —Å –ø—É—Å—Ç—ã–º JSON"
          echo "===================================="
          curl -v -X GET \
            --header 'Accept: application/json' \
            --header 'Content-Type: application/json' \
            --header "Authorization: Bearer ${{ secrets.FRIENDWORK_API_TOKEN }}" \
            --data '{}' \
            'https://api.friend.work/jobs'
          echo ""
          echo "===================================="

      # üîç –¢–ï–°–¢ 3: POST –∑–∞–ø—Ä–æ—Å (–º–æ–∂–µ—Ç API –∏–∑–º–µ–Ω–∏–ª—Å—è)
      - name: üîç –¢–ï–°–¢ 3 - POST –∑–∞–ø—Ä–æ—Å
        run: |
          echo "===================================="
          echo "üîç –¢–ï–°–¢ 3: POST –∑–∞–ø—Ä–æ—Å"
          echo "===================================="
          curl -v -X POST \
            --header 'Accept: application/json' \
            --header 'Content-Type: application/json' \
            --header "Authorization: Bearer ${{ secrets.FRIENDWORK_API_TOKEN }}" \
            --data '{"statuses": ["open", "onHold"], "paging": {"page": 0, "count": 1}}' \
            'https://api.friend.work/jobs/search'
          echo ""
          echo "===================================="

      # üîç –¢–ï–°–¢ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –≤–∞–∫–∞–Ω—Å–∏–∏
      - name: üîç –¢–ï–°–¢ 4 - –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–¥–Ω–æ–π –≤–∞–∫–∞–Ω—Å–∏–∏
        run: |
          echo "===================================="
          echo "üîç –¢–ï–°–¢ 4: –ü–æ–ª—É—á–µ–Ω–∏–µ –≤–∞–∫–∞–Ω—Å–∏–∏ –ø–æ ID"
          echo "===================================="
          # –ü–æ–ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –≤–∞–∫–∞–Ω—Å–∏—é —Å ID 26084 (–∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏)
          curl -v -X GET \
            --header 'Accept: application/json' \
            --header "Authorization: Bearer ${{ secrets.FRIENDWORK_API_TOKEN }}" \
            'https://api.friend.work/jobs/26084'
          echo ""
          echo "===================================="

      # üîç –¢–ï–°–¢ 5: –¢–≤–æ–π –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å
      - name: üîç –¢–ï–°–¢ 5 - –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å
        run: |
          echo "===================================="
          echo "üîç –¢–ï–°–¢ 5: –¢–≤–æ–π –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å"
          echo "===================================="
          curl -v --request GET \
            --header 'Accept: application/json' \
            --header 'Content-Type: application/json' \
            --header "Authorization: Bearer ${{ secrets.FRIENDWORK_API_TOKEN }}" \
            --data "{\"statuses\": [\"open\", \"onHold\"], \"paging\": { \"page\": 0, \"count\": 1 }}" \
            'https://api.friend.work/jobs'
          echo ""
          echo "===================================="

      # –ï—Å–ª–∏ –¢–ï–°–¢ 4 —Å—Ä–∞–±–æ—Ç–∞–µ—Ç (–ø–æ–ª—É—á–µ–Ω–∏–µ –æ–¥–Ω–æ–π –≤–∞–∫–∞–Ω—Å–∏–∏), 
      # –Ω–æ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –Ω–µ—Ç - –∑–Ω–∞—á–∏—Ç –ø—Ä–æ–±–ª–µ–º–∞ –≤ –ø–æ–∏—Å–∫–µ
      
      - name: Fetch all FriendWork jobs and details
        if: false  # –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–¥
        run: |
          page=0
          count=50
          jobids=()
          while :; do
            resp=$(curl -s --request GET \
              --header 'Accept: application/json' \
              --header 'Content-Type: application/json' \
              --header "Authorization: Bearer ${{ secrets.FRIENDWORK_API_TOKEN }}" \
              --data "{\"statuses\": [\"open\", \"onHold\"], \"paging\": { \"page\": $page, \"count\": $count }}" \
              'https://api.friend.work/jobs')
            items=$(echo "$resp" | jq '.Items')
            n=$(echo "$items" | jq 'length')
            if [ "$n" -eq 0 ]; then
              break
            fi
            ids=$(echo "$items" | jq -r '.[].jobId')
            for id in $ids; do
              jobids+=($id)
            done
            page=$((page+1))
          done

          details=()
          for jobid in "${jobids[@]}"; do
            detail=$(curl -s -X GET \
              --header 'Accept: application/json' \
              --header "Authorization: Bearer ${{ secrets.FRIENDWORK_API_TOKEN }}" \
              "https://api.friend.work/jobs/$jobid")
            if echo "$detail" | jq empty 2>/dev/null; then
              details+=("$detail")
            fi
          done

          printf '%s\n' "${details[@]}" | jq -s '.' > Beliy_Mys_VAC/jobs_full.json

      - name: Upload jobs_full.json
        if: false
        uses: actions/upload-artifact@v4
        with:
          name: friendwork-jobs-full
          path: Beliy_Mys_VAC/jobs_full.json

      - name: Debug jobs_full.json
        if: false
        run: cat Beliy_Mys_VAC/jobs_full.json

      - name: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Python –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
        if: false
        run: |
          python -m pip install --upgrade pip
          pip install pandas requests

      - name: –≠–∫—Å–ø–æ—Ä—Ç –¥–ª—è Supabase
        if: false
        run: python export_to_supabase.py
        working-directory: Beliy_Mys_VAC

      - name: –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤ vacancies_rows.csv
        if: false
        run: python convert_to_vacancies_rows.py
        working-directory: Beliy_Mys_VAC

      - name: Upload jobs_supabase.csv
        if: false
        uses: actions/upload-artifact@v4
        with:
          name: friendwork-jobs-supabase
          path: Beliy_Mys_VAC/jobs_supabase.csv

      - name: –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ Supabase
        if: false
        run: python upload_to_supabase.py
        working-directory: Beliy_Mys_VAC

      - name: Upload vacancies_rows.csv
        if: false
        uses: actions/upload-artifact@v4
        with:
          name: friendwork-vacancies-rows
          path: Beliy_Mys_VAC/vacancies_rows.csv
