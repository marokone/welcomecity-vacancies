name: Fetch FriendWork Jobs Full

on:
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * *'

jobs:
  fetch-jobs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Debug FriendWork API response
        run: |
          resp=$(curl -s -X GET \
            --header 'Accept: application/json' \
            --header 'Content-Type: application/json' \
            --header "Authorization: Bearer ${{ secrets.FRIENDWORK_API_TOKEN }}" \
            -d "{\"statuses\": [\"open\", \"onHold\"], \"paging\": { \"page\": 0, \"count\": 1 }}" \
            'https://api.friend.work/jobs')
          echo "$resp"

      - name: Fetch all FriendWork jobs and details
        run: |
          page=0
          count=50
          jobids=()
          while :; do
            resp=$(curl -s -X GET \
              --header 'Accept: application/json' \
              --header 'Content-Type: application/json' \
              --header "Authorization: Bearer ${{ secrets.FRIENDWORK_API_TOKEN }}" \
              -d "{\"statuses\": [\"open\", \"onHold\"], \"paging\": { \"page\": $page, \"count\": $count }}" \
              'https://api.friend.work/jobs')
            items=$(echo "$resp" | jq '.Items')
            n=$(echo "$items" | jq 'length')
            if [ "$n" -eq 0 ]; then
              break
            fi
            ids=$(echo "$items" | jq -r '.[].jobId')
            for id in $ids; do
              jobids+=($id)
            done
            page=$((page+1))
          done

          details=()
          for jobid in "${jobids[@]}"; do
            detail=$(curl -s -X GET \
              --header 'Accept: application/json' \
              --header "Authorization: Bearer ${{ secrets.FRIENDWORK_API_TOKEN }}" \
              "https://api.friend.work/jobs/$jobid")
            # Добавляем только валидные JSON-объекты
            if echo "$detail" | jq empty 2>/dev/null; then
              details+=("$detail")
            fi
          done

          # Собираем массив JSON-объектов
          printf '%s\n' "${details[@]}" | jq -s '.' > Beliy_Mys_VAC/jobs_full.json

      - name: Upload jobs_full.json
        uses: actions/upload-artifact@v4
        with:
          name: friendwork-jobs-full
          path: Beliy_Mys_VAC/jobs_full.json

      - name: Debug jobs_full.json
        run: cat Beliy_Mys_VAC/jobs_full.json

      - name: Установить Python и зависимости
        run: |
          python -m pip install --upgrade pip
          pip install beautifulsoup4 lxml pandas

      - name: Парсинг описаний вакансий
        run: python parse_descriptions.py
        working-directory: ${{ github.workspace }}/Beliy_Mys_VAC


      - name: Экспорт для Supabase
        run: python export_to_supabase.py
        working-directory: ${{ github.workspace }}/Beliy_Mys_VAC

      - name: Преобразование в vacancies_rows.csv
        run: python convert_to_vacancies_rows.py
        working-directory: ${{ github.workspace }}/Beliy_Mys_VAC/

      - name: Upload jobs_supabase.csv
        uses: actions/upload-artifact@v4
        with:
          name: friendwork-jobs-supabase
          path: Beliy_Mys_VAC/jobs_supabase.csv

      - name: Upload vacancies_rows.csv
        uses: actions/upload-artifact@v4
        with:
          name: friendwork-vacancies-rows
          path: Beliy_Mys_VAC/vacancies_rows.csv

      - name: Upload jobs_structured.json
        uses: actions/upload-artifact@v4
        with:
          name: friendwork-jobs-structured
          path: Beliy_Mys_VAC/jobs_structured.json
